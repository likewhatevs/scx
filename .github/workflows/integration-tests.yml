name: build-and-test

on:
  workflow_call:
    inputs:
      repo-name:
        type: string

jobs:
  list-tests:
    runs-on: ${{ github.repository_owner == 'likewhatevs' && fromJSON('[ "self-hosted", "Linux", "X64", "large" ]') || 'ubuntu-latest' }}
    outputs:
      matrix: ${{ steps.output.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List tests
        id: output
        run: python3 .github/include/list-integration-tests.py "${{ inputs.repo-name }}" >> $GITHUB_OUTPUT

  integration-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: list-tests
    strategy:
      matrix:
        scheduler: ${{ fromJson(needs.list-tests.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/install-deps-action
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.scheduler.name }}
          prefix-key: "4"

      - name: Resolve kernel
        run: |
          KERNEL="${{ matrix.scheduler.kernel }}"
          if [ -z "$KERNEL" ]; then
            KERNEL="sched_ext/for-next"
          fi
          KERNEL_NAME=$(echo "$KERNEL" | tr '/' '_')
          KERNEL_URL=$(jq -r --arg k "$KERNEL" '.[$k].repo' kernel-versions.json)
          KERNEL_TAG=$(jq -r --arg k "$KERNEL" '.[$k].branch' kernel-versions.json)
          echo "KERNEL_NAME=$KERNEL_NAME" >> $GITHUB_ENV
          echo "KERNEL_URL=$KERNEL_URL" >> $GITHUB_ENV
          echo "KERNEL_TAG=$KERNEL_TAG" >> $GITHUB_ENV

      - name: Build scheduler
        run: cargo build -p ${{ matrix.scheduler.name }}

      - name: Test scheduler
        uses: ./.github/actions/vng
        with:
          name: kernel-${{ env.KERNEL_NAME }}
          kernel-url: ${{ env.KERNEL_URL }}
          kernel-tag: ${{ env.KERNEL_TAG }}
          kconfig: kernel.config
          cpus: 8
          memory: 10G
          run: |
            timeout --foreground --preserve-status 30 \
              target/debug/${{ matrix.scheduler.name }} ${{ matrix.scheduler.flags || '-v' }}

      - name: Stress test
        uses: ./.github/actions/vng
        with:
          name: kernel-${{ env.KERNEL_NAME }}
          kernel-url: ${{ env.KERNEL_URL }}
          kernel-tag: ${{ env.KERNEL_TAG }}
          kconfig: kernel.config
          cpus: 10
          memory: 10G
          run: |
            stress-ng -t 31 --aggressive -M -c $(nproc) -f $(nproc) \
              --affinity 1 --affinity-delay 1 --affinity-pin &
            timeout --foreground --preserve-status 45 \
              target/debug/${{ matrix.scheduler.name }} ${{ matrix.scheduler.flags || '-v' }}

  all-success:
    needs: integration-test
    runs-on: ${{ github.repository_owner == 'likewhatevs' && fromJSON('[ "self-hosted", "Linux", "X64", "large" ]') || 'ubuntu-latest' }}
    if: always()
    env:
      NEEDS_CONTEXT: ${{ toJSON(needs) }}
    steps:
      - uses: actions/checkout@v4
      - run: echo "$NEEDS_CONTEXT" | jq -e 'to_entries | all(.value.result == "success")'
